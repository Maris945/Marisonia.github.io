<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Home Avanzata - Jobby</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { font-family: Arial, sans-serif; margin:0; }
.navbar { margin-bottom:20px; }
.section { padding:60px 15px; }

/* Annunci lavoro */
.job-form, .job-card {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.08);
  margin-bottom: 20px;
}

.job-card {
  transition: transform 0.3s, box-shadow 0.3s;
}

.job-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}

.job-card h4 { margin-bottom: 8px; }
.job-card p { margin-bottom: 10px; }

.job-card button {
  background-color: #0d6efd;
  border: none;
  color: #fff;
  padding: 6px 15px;
  border-radius: 8px;
  cursor: pointer;
  margin-right:5px;
}

.job-card button:hover { background-color: #0b5ed7; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="home-advanced.html">Jobby</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="home-advanced.html">Home</a></li>
        <li class="nav-item"><a class="nav-link protetto" href="obiettivi.html">Obiettivi</a></li>
        <li class="nav-item"><a class="nav-link protetto" href="descrizione.html">Descrizione</a></li>
        <li class="nav-item"><a class="nav-link protetto" href="contatti.html">Contatti</a></li>
        <li class="nav-item"><button id="logoutBtn" class="nav-link btn btn-link protetto">Logout</button></li>
      </ul>
    </div>
  </div>
</nav>

<!-- Sezione Annunci Avanzata -->
<section class="section" id="jobListingsAdvanced">
  <div class="container">
    <h1 class="text-center">Annunci di lavoro - Avanzata</h1>

    <!-- Filtro annunci -->
    <div class="mb-4">
      <input type="text" id="filterInput" class="form-control" placeholder="Filtra per titolo o azienda">
    </div>

    <!-- Form pubblica annuncio -->
    <div class="job-form mt-4 mb-5">
      <h3>Pubblica un annuncio</h3>
      <form id="createJobFormAdv">
        <input type="text" id="jobTitleAdv" placeholder="Titolo annuncio" required>
        <input type="text" id="jobCompanyAdv" placeholder="Azienda" required>
        <textarea id="jobDescriptionAdv" rows="3" placeholder="Descrizione" required></textarea>
        <button type="submit">Pubblica</button>
      </form>
      <p id="jobStatusAdv" class="mt-2"></p>
    </div>

    <!-- Lista annunci -->
    <div id="jobsListAdv" class="mt-4"></div>

    <!-- Bottone Accedi / Registrati -->
    <div id="loginRegisterBtn" class="mt-4 text-center">
      <a href="index.html" class="btn btn-secondary">Accedi / Registrati</a>
    </div>
  </div>
</section>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBGgjzIMmW1YxBXTeatlf9gMHzADvER_8A",
  authDomain: "jobby-f704a.firebaseapp.com",
  projectId: "jobby-f704a",
  storageBucket: "jobby-f704a.firebasestorage.app",
  messagingSenderId: "320047348",
  appId: "1:320047348:web:f4fab4bb3fa8b865b9f6a1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Elementi DOM
const protetti = document.querySelectorAll('.nav-link.protetto');
const logoutBtn = document.getElementById("logoutBtn");
const loginRegisterBtn = document.getElementById("loginRegisterBtn");
const content = document.getElementById("jobListingsAdvanced");
const jobsList = document.getElementById("jobsListAdv");

// Stato utente
protetti.forEach(el => el.style.display = "none");
content.style.display = "none";

auth.onAuthStateChanged(user => {
  if(user){
    protetti.forEach(el => el.style.display = "block");
    content.style.display = "block";
    loginRegisterBtn.style.display = "none";
    loadJobsAdv();
  } else {
    protetti.forEach(el => el.style.display = "none");
    content.style.display = "none";
    loginRegisterBtn.style.display = "block";
  }
});

// Logout
logoutBtn.addEventListener("click", () => {
  auth.signOut().then(() => window.location.href="index.html");
});

// Pubblica annuncio
document.getElementById("createJobFormAdv").addEventListener("submit", function(e){
  e.preventDefault();
  const user = firebase.auth().currentUser;
  if(!user){ alert("Devi essere loggato per pubblicare!"); return; }

  const title = document.getElementById("jobTitleAdv").value;
  const company = document.getElementById("jobCompanyAdv").value;
  const description = document.getElementById("jobDescriptionAdv").value;

  db.collection("jobs").add({
    title, company, description,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    creatorUid: user.uid
  }).then(() => {
    document.getElementById("jobStatusAdv").textContent = "Annuncio pubblicato!";
    document.getElementById("createJobFormAdv").reset();
    loadJobsAdv();
  });
});

// Carica annunci con filtro
function loadJobsAdv(){
  const filter = document.getElementById("filterInput").value.toLowerCase();
  jobsList.innerHTML = "";

  db.collection("jobs").orderBy("createdAt","desc").get().then(snapshot => {
    snapshot.forEach(doc => {
      const job = doc.data();
      if(job.title.toLowerCase().includes(filter) || job.company.toLowerCase().includes(filter)){
        const card = document.createElement("div");
        card.className = "job-card p-3 mb-3";
        const user = firebase.auth().currentUser;
        const isCreator = user && user.uid === job.creatorUid;
        card.innerHTML = `
          <h4>${job.title}</h4>
          <p><strong>Azienda:</strong> ${job.company}</p>
          <p>${job.description}</p>
          <button onclick="applyJob('${doc.id}')">Iscriviti</button>
          ${isCreator ? `<button onclick="deleteJob('${doc.id}')">Elimina</button>` : ""}
        `;
        jobsList.appendChild(card);
      }
    });
  });
}

// Iscrizione annuncio
function applyJob(jobId){
  const user = firebase.auth().currentUser;
  if(!user){ alert("Devi essere loggato per iscriverti!"); return; }
  db.collection("jobs").doc(jobId).collection("applicants").doc(user.uid).set({
    email: user.email,
    appliedAt: firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=> alert("Iscrizione completata!"));
}

// Elimina annuncio
function deleteJob(jobId){
  if(confirm("Vuoi davvero eliminare questo annuncio?")){
    db.collection("jobs").doc(jobId).delete().then(()=> loadJobsAdv());
  }
}

// Filtro dinamico
document.getElementById("filterInput").addEventListener("input", loadJobsAdv);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>